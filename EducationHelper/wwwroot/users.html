
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Home</title>

    <environment include="Development">
        <script type="text/javascript" src="js/md5.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
        <script>
            async function checkAuthAsync() {

                const checkAuths = await fetch("/checkAuth", {
                    method: "GET",
                    headers: {
                        "Accept": "application/json",
                        "Authorization": "Bearer " + sessionStorage.getItem(tokenKey)  // передача токена в заголовке
                    }
                });
                if (checkAuths.ok) {
                    return true;
                }
                else {
                    return false;
                }
            }
        </script>
    </environment>
    <environment exclude="Development">
        <link rel="stylesheet" href="https://ajax.aspnetcdn.com/ajax/bootstrap/3.3.7/css/bootstrap.min.css"
              asp-fallback-href="~/lib/bootstrap/dist/css/bootstrap.min.css"
              asp-fallback-test-class="sr-only" asp-fallback-test-property="position" asp-fallback-test-value="absolute" />
    </environment>
</head>
<body>
    <nav class="navbar navbar-inverse navbar-fixed-top">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a href="index.html" class="navbar-brand">EducationHelper</a>
            </div>
            <div class="navbar-collapse collapse" >
                <ul class="nav navbar-nav" id="menu" style="display:none">
                    <li><a href="">Персональная информация</a></li>
                    <li><a href="">Новости</a></li>
                    <li><a href="">Голлосования</a></li>
                    <li><a href="classes.html">Классы</a></li>
                    <li><a href="users.html">Пользователи</a></li>
                    <li><a href="" id="logout">Выход</a></li>
                </ul>
            </div>
        </div>
    </nav>
    <div class="container body-content" style="display:block">
        <h2>Пользователи</h2>
        <br />
        <div class="cell">
            <table class="table" id="data">
                <thead>
                    <tr>
                        <th>
                            Логин
                        </th>
                        <th>
                            Пароль
                        </th>
                        <th>
                            Фамилия
                        </th>
                        <th>
                            Имя
                        </th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
        <form name="edit" class="cell">
            <h3>Редактирование данных</h3><br />
            <table class="table">
                <tr>
                    <td><label class="control-label">Номер</label></td>
                    <td colspan="2"><input type="text" name="number" readonly class="form-control" /></td>
                </tr>
                <tr>
                    <td><label class="control-label">Логин</label></td>
                    <td colspan="2"><input type="text" name="login" class="form-control" /></td>
                </tr>
                <tr>
                    <td><label class="control-label">Пароль</label></td>
                    <td colspan="2"><input type="text" name="pass" class="form-control" /></td>
                </tr>
                <tr>
                    <td><label class="control-label">Фамилия</label></td>
                    <td colspan="2"><input type="text" name="surname" class="form-control" /></td>
                </tr>
                <tr>
                    <td><label class="control-label">Имя</label></td>
                    <td colspan="2"><input type="text" name="firstname" class="form-control" /></td>
                </tr>
                <tr>
                    <td><input type="button" name="add" value="Добавить" class="btn btn-default" /></td>
                    <td><input type="button" name="del" value="Удалить" class="btn btn-default" /></td>
                    <td><input type="button" name="upd" value="Обновить" class="btn btn-default" /></td>
                </tr>
            </table>
            <div id="msg_display"></div>
        </form>
        <script type="text/javascript">
            $(function () {
                        GetAll();
 
                $("#upd").click(function (event) {
                    event.preventDefault();
                    Edit();
                });
 
                $("#add").click(function (event) {
                    event.preventDefault();
                    Add();
                });
 
            });
            // Получение всехпо ajax-запросу
            function GetAll() {
                $.ajax({
                    url: '/users',
                    type: 'GET',
                    dataType: 'json',
                    success: function (data) {
                        WriteResponse(data);
                    },
                    error: function (x, y, z) {
                        alert(x + '\n' + y + '\n' + z);
                    }
                });
            }
         // Добавление новой
            function Add() {
                // получаем значения
                var user = {
                    Login: $('#login').val(),
                    Password: $('#pass').val(),
                    Surname: $('#surname').val(),
                    Firstname : $('#firstname').val()
                };
  
                $.ajax({
                    url: '/users',
                    type: 'POST',
                    data: JSON.stringify(user),
                    contentType: "application/json;charset=utf-8",
                    success: function (data) {
                        GetAll();
                    },
                    error: function (x, y, z) {
                        alert(x + '\n' + y + '\n' + z);
                    }
                });
            }
         // Удаление
            function Delete(id) {
  
                $.ajax({
                    url: '/users/' + id,
                    type: 'DELETE',
                    contentType: "application/json;charset=utf-8",
                    success: function (data) {
                        GetAll();
                    },
                    error: function (x, y, z) {
                        alert(x + '\n' + y + '\n' + z);
                    }
                });
            }
            // редактирование
            function Edit() {
                var id = $('#number').val()
                // получаем новые значения 
                var user = {
                    Login: $('#login').val(),
                    Password: $('#pass').val(),
                    Surname: $('#surname').val(),
                    Firstname : $('#firstname').val()
                };
                $.ajax({
                    url: '/users/' + id,
                    type: 'PUT',
                    data: JSON.stringify(user),
                    contentType: "application/json;charset=utf-8",
                    success: function (data) {
                        GetAll();
                    },
                    error: function (x, y, z) {
                        alert(x + '\n' + y + '\n' + z);
                    }
                });
            }
         // вывод полученных данных на экран
            function WriteResponse(users) {
                strResult = "";
                $.each(users, function (index, user) {
                    strResult = "<tr><td>" + user.Id + "</td><td> " + user.Login + "</td><td>" +
                        user.Password + "</td><td>" + user.Surname + "</td><td>" + user.Firstname  +"</td></tr>"
                    $('tbody').append(strResult);
                });
                
                
         
            }
            // обработчик удаления
            function DeleteItem(el) {
                // получаем id удаляемого объекта
                var id = $('#number').val();
                Delete(id);
            }
            // обработчик редактирования
            function EditItem (el) {
                // получаем id редактируемого объекта
                var id = $('#number').val();
                Get(id);
            };
        </script>
    </div>

        <script type="text/javascript" src="js/login.js"></script>
        <script src="https://ajax.aspnetcdn.com/ajax/jquery/jquery-3.3.1.min.js"
                asp-fallback-src="~/lib/jquery/dist/jquery.min.js"
                asp-fallback-test="window.jQuery"
                crossorigin="anonymous"
                integrity="sha384-tsQFqpEReu7ZLhBV2VZlAu7zcOV+rXbYlF2cqB8txI/8aZajjp4Bqd+V6D5IgvKT">
        </script>
        <script src="https://ajax.aspnetcdn.com/ajax/bootstrap/3.3.7/bootstrap.min.js"
                asp-fallback-src="~/lib/bootstrap/dist/js/bootstrap.min.js"
                asp-fallback-test="window.jQuery && window.jQuery.fn && window.jQuery.fn.modal"
                crossorigin="anonymous"
                integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa">
        </script>
        <script>
            checkAuthAsync().then(changeIndex);
        </script>
</body>
</html>